<% if user_signed_in? && current_user.quiz_completed? %>
  <!-- Hero Section + Modal Custom -->
  <div data-controller="modal">
    <div class="mystic-hero-section">
      <div class="hero-stars"></div>
      <div class="hero-content">
        <div class="hero-icon">
          <i class="bi bi-moon-stars-fill"></i>
        </div>
        <h1 class="hero-title">Plongez dans vos rêves</h1>
        <p class="hero-subtitle">Laissez l'IA révéler les mystères cachés de votre inconscient</p>
        <button type="button" class="btn btn-mystic-hero btn-lg" data-action="click->modal#open">
          <i class="bi bi-stars"></i> Enregistrer un rêve
        </button>
      </div>
      <div class="hero-waves">
        <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
          <path d="M0,0 C150,100 350,0 500,50 C650,100 850,0 1000,50 L1200,50 L1200,120 L0,120 Z" fill="rgba(10, 10, 15, 0.3)"></path>
        </svg>
      </div>
    </div>

    <!-- Modal Custom (sans Bootstrap) -->
    <div class="custom-modal-overlay" data-modal-target="overlay" data-action="click->modal#closeOnOverlay">
      <div class="custom-modal-dialog" data-modal-target="dialog" data-controller="loading">
        <div class="custom-modal-header">
          <h2 class="custom-modal-title">
            <i class="bi bi-stars"></i> Nouveau Rêve
          </h2>
          <button type="button" class="custom-modal-close" data-action="click->modal#close" aria-label="Fermer">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="custom-modal-body">
          <%= form_with model: @dream, url: dreams_path, class: "mystic-form", data: { action: "submit->loading#start" } do |f| %>
            <div class="mb-3">
              <%= f.label :date, "Date du rêve", class: "form-label" %>
              <%= f.date_field :date, class: "form-control", data: { controller: "flatpickr", flatpickr_date_format_value: "d/m/Y", flatpickr_max_date_value: "today" } %>
              <% if @dream.errors[:date].any? %>
                <div class="text-danger mt-1"><%= @dream.errors[:date].first %></div>
              <% end %>
            </div>

            <div class="mb-4" data-controller="speech">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <%= f.label :content, "Décrivez votre rêve en détail", class: "form-label mb-0" %>
                <button type="button" class="btn btn-speech btn-sm" data-speech-target="button" data-action="click->speech#toggle">
                  <i class="bi bi-mic"></i> Dicter
                </button>
              </div>
              <div class="speech-status" data-speech-target="status" style="display: none;"></div>
              <%= f.text_area :content, class: "form-control", placeholder: "Décrivez votre rêve avec le plus de détails possible...", rows: 8, data: { speech_target: "input" } %>
              <% if @dream.errors[:content].any? %>
                <div class="text-danger mt-1"><%= @dream.errors[:content].first %></div>
              <% end %>
              <small class="form-text text-muted mt-2">
                <i class="bi bi-lightbulb"></i> Le titre sera généré automatiquement par l'IA
              </small>
            </div>

            <div class="custom-modal-actions">
              <button type="button" class="btn btn-mystic-secondary" data-action="click->modal#close">Annuler</button>
              <%= f.submit "Analyser mon rêve", class: "btn btn-mystic btn-lg", data: { loading_target: "button" } %>
            </div>
          <% end %>
        </div>

        <!-- Overlay de chargement -->
        <div class="custom-loading-overlay" data-loading-target="overlay" style="display: none;">
          <div class="loading-spinner-container" data-loading-target="spinner">
            <div class="mystic-spinner">
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
            </div>
            <p class="loading-text">
              <i class="bi bi-stars"></i><br>
              L'IA analyse votre rêve...<br>
              <small>Plongez dans les mystères de votre inconscient</small>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

<% elsif user_signed_in? %>
  <div class="mystic-hero">
    <h1><i class="bi bi-moon-stars-fill"></i> Bienvenue dans DreamCatcher</h1>
    <p>Complétez d'abord le quiz initial pour commencer votre voyage onirique</p>
    <%= link_to "Commencer le quiz", new_quiz_path, class: "btn btn-mystic btn-lg" %>
  </div>
<% else %>
  <!-- Hero Section pour visiteurs non connectés -->
  <div class="mystic-hero-section">
    <div class="hero-stars"></div>
    <div class="hero-content">
      <div class="hero-icon">
        <i class="bi bi-moon-stars-fill"></i>
      </div>
      <h1 class="hero-title">DreamCatcher</h1>
      <p class="hero-subtitle">Découvrez les mystères cachés dans vos rêves grâce à l'intelligence artificielle</p>
      <div class="hero-buttons">
        <%= link_to "Inscription", new_user_registration_path, class: "btn btn-mystic-hero btn-lg me-3" %>
        <%= link_to "Connexion", new_user_session_path, class: "btn btn-mystic-hero-secondary btn-lg" %>
      </div>
    </div>
    <div class="hero-waves">
      <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
        <path d="M0,0 C150,100 350,0 500,50 C650,100 850,0 1000,50 L1200,50 L1200,120 L0,120 Z" fill="rgba(10, 10, 15, 0.3)"></path>
      </svg>
    </div>
  </div>

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-4 mb-4">
        <div class="mystic-card text-center">
          <i class="bi bi-stars" style="font-size: 3rem; color: #fbbf24; margin-bottom: 1rem;"></i>
          <h3>Analyse détaillée</h3>
          <p>Obtenez une interprétation approfondie de vos rêves basée sur la psychologie et le symbolisme mystique.</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="mystic-card text-center">
          <i class="bi bi-graph-up-arrow" style="font-size: 3rem; color: #6b46c1; margin-bottom: 1rem;"></i>
          <h3>Analyse globale</h3>
          <p>Découvrez les patterns et thèmes récurrents dans l'ensemble de vos rêves sur une période.</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="mystic-card text-center">
          <i class="bi bi-journal-text" style="font-size: 3rem; color: #ec4899; margin-bottom: 1rem;"></i>
          <h3>Historique complet</h3>
          <p>Conservez tous vos rêves et leurs analyses dans un journal personnel sécurisé.</p>
        </div>
      </div>
    </div>
  </div>
<% end %>
