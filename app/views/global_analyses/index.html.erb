<div class="container" data-controller="loading">
  <div class="mystic-hero">
    <h1><i class="bi bi-graph-up-arrow"></i> Analyses Globales</h1>
    <p>SynthÃ¨se de vos rÃªves pour identifier les patterns rÃ©currents</p>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <% if @can_generate %>
        <div class="mystic-card">
          <h2><i class="bi bi-stars"></i> GÃ©nÃ©rer une nouvelle analyse globale</h2>
          <p class="mb-4">
            Vous avez <strong><%= @dreams_count %></strong> rÃªve(s) enregistrÃ©(s). Choisissez combien de rÃªves analyser pour dÃ©couvrir les thÃ¨mes rÃ©currents et les messages de votre inconscient.
          </p>

          <div class="dreams-count-options">
            <% [[2, "Les 2 derniers"], [5, "Les 5 derniers"], [10, "Les 10 derniers"], [20, "Les 20 derniers"]].each do |count, label| %>
              <% if @available_options.include?(count) %>
                <%= form_with url: global_analyses_path, method: :post, class: "d-inline-block", data: { action: "submit->loading#start" } do |f| %>
                  <%= f.hidden_field :dreams_count, value: count %>
                  <%= f.submit label, class: "btn btn-dreams-count", data: { loading_target: "button" } %>
                <% end %>
              <% else %>
                <button class="btn btn-dreams-count disabled" disabled title="Vous avez besoin d'au moins #{count} rÃªves">
                  <%= label %>
                  <small class="d-block">(<%= count - @dreams_count %> rÃªve(s) manquant(s))</small>
                </button>
              <% end %>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="mystic-card">
          <div class="text-center">
            <i class="bi bi-moon" style="font-size: 4rem; color: #1B4D3E; margin-bottom: 1rem;"></i>
            <h3>Pas assez de rÃªves</h3>
            <p>Vous devez avoir enregistrÃ© au moins <strong>2 rÃªves</strong> pour obtenir une analyse globale.</p>
            <p class="text-muted">Vous avez actuellement <%= @dreams_count %> rÃªve(s).</p>
            <%= link_to "Enregistrer un rÃªve", root_path, class: "btn btn-mystic mt-3" %>
          </div>
        </div>
      <% end %>

      <% if @global_analyses.any? %>
        <div class="mt-5">
          <h2 class="mb-4" style="color: #E6C868;">
            <i class="bi bi-clock-history"></i> Historique des analyses
          </h2>

          <% @global_analyses.each do |analysis| %>
            <div class="dream-item position-relative">
              <%= link_to global_analysis_path(analysis), class: "text-decoration-none" do %>
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="dream-title">
                      <i class="bi bi-graph-up-arrow"></i>
                      <% if analysis.first_dream_date.present? && analysis.last_dream_date.present? %>
                        Analyse du <%= analysis.first_dream_date.strftime("%d/%m") %> au <%= analysis.last_dream_date.strftime("%d/%m/%Y") %>
                      <% else %>
                        Analyse globale
                      <% end %>
                      <% if analysis.dreams_count.present? %>
                        <span class="badge-dreams-count"><%= analysis.dreams_count %> rÃªves</span>
                      <% end %>
                    </div>
                    <div class="dream-date">
                      <i class="bi bi-calendar"></i> <%= analysis.created_at.strftime("%d/%m/%Y Ã  %H:%M") %>
                    </div>
                    <div class="dream-preview mt-2">
                      <%= clean_analysis_preview(analysis.interpretation, length: 200) %>
                    </div>
                  </div>
                  <div>
                    <i class="bi bi-arrow-right" style="color: #1B4D3E; font-size: 1.5rem;"></i>
                  </div>
                </div>
              <% end %>
              <%= button_to global_analysis_path(analysis), method: :delete, class: "btn-delete-item", form_class: "delete-form", data: { action: "click->confirm#open", confirm_title: "Supprimer cette analyse ?", confirm_message: "Cette action supprimera dÃ©finitivement cette analyse globale du <strong>#{analysis.created_at.strftime('%d/%m/%Y')}</strong>.\n\nCette action est irrÃ©versible.", confirm_text: "Supprimer", confirm_type: "danger" } do %>
                <i class="bi bi-trash"></i>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mystic-card mt-4 text-center">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #1B4D3E; margin-bottom: 1rem;"></i>
          <h3>Aucune analyse globale</h3>
          <p>GÃ©nÃ©rez votre premiÃ¨re analyse globale pour dÃ©couvrir les patterns dans vos rÃªves.</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Loader Fullscreen pour analyse globale -->
  <div class="loading-fullscreen" data-loading-target="overlay" style="display: none;">
    <div class="loading-fullscreen-content">
      <div class="mystic-spinner-large">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-moon">ğŸŒ™</div>
      </div>
      <h2 class="loading-title">Analyse en cours...</h2>
      <p class="loading-text">
        L'IA analyse l'ensemble de vos rÃªves<br>
        <small>DÃ©couverte des patterns et thÃ¨mes rÃ©currents</small>
      </p>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
</div>
